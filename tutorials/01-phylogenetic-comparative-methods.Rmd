---
title: "PSDA Tutorial"
date: "April 12, 2017"
output: html_document
---

```{r setup, include=FALSE}
library(ape)
library(phytools)
library(magrittr)
library(nlme)

set.seed(1)
tree <- rtree(10)
```

## Phylogenetic Comparative Methods

Phylogenetic Comparative Methods (PCMs) aim to control for confounding variation in the phylogeny when performing tests or regression models among traits and between traits and environmental meta data.

# Simulating Trait Evolution
PCMs have been developed often with explicit evolutionary hypotheses in mind. Usually, these come in the form of diffusion processes along the phylogeny, such as a Brownian Motion model simulated using `fastBM` from the package `phytools`.

```{r Simulating continuous trait}
x <- fastBM(tree,sig2 = 0.01)
par(mfrow=c(1,2))
plot.phylo(tree,main='Phylogeny')
phenogram(tree,x,main='Phenogram of BM on tree')
```

One can also simulate categorical variables using `sim.history` and a transition matrix, Q (note: Q is not a stochastic matrix, but a matrix whose rows and columns sum to 0)

```{r Simulating categorical trait}
########### Simulate categorical variable
Q <- matrix(c(-1,.5,0,0,.5,
              .5,-1,.5,0,0,
              0,.5,-1,.5,0,
              0,0,.5,-1,.5,
              .5,0,0,.5,-1),ncol=5)

M <- sim.history(tree,Q,anc='3')
par(mfrow=c(1,1))
plotSimmap(M)
```

One can also use this machinery to simulate integer-valued traits, such as RNA copy number.
```{r Simulating integer-valued variables}
Q <- diag(9) %>% cbind(rep(0,9),.) %>% rbind(.,rep(0,10)) 
Q <- Q+t(Q)-diag(10)
Q <- 3*Q
RNAcopyNumber <- sim.history(tree,Q,anc = '3')
RNAcopyNumber$states
plotSimmap(RNAcopyNumber)
```

# Phylogenetic t-tests and generalized least squares

Phylogenetic comparative methods were developed to control for confounding variation caused by common ancestry of organisms when looking for correlations among traits or between traits and habitat conditions. When traits have a phylogenetic signal, failing to control for the phylogeny can lead to a high false-positive rate - uncorrelated traits may appear correlated due to phylogenetic dependecne. Correcting for the phylogenetic dependence can improve the robustness of tests. If, however, traits do not have a phylogenetic signal, as one might expect with extensive horizontal gene transfer, correcting for phylogenetic dependence will lead to a high false-negative rate. 

To illustrate this, we'll simulate 100 pairs of independent, continuous-valued traits diffusing along the phylogeny using `fastBM` and look at the resulting distribution of P-values obtained from regular t-tests and phylogenetic t-tests. Finally, to illustrate the high false-negative rate of phylogenetic t-tests under horizontal gene transfer, we'll simulate 100 pairs of completely independent, normal random variables, swapping the trait values by sampling with replacement, and perform phylogenetic t-tests on the sampled-with-replacement vectors.

```{r}
reps=300
Pvals.orig <- numeric(reps)
Pvals.phyl <- numeric(reps)
Pvals.HGT <- numeric(reps)
P2 <- numeric(reps)
for (nn in 1:reps){
  x <- fastBM(tree)
  y <- fastBM(tree)
  Pvals.phyl[nn] <- phyl.pairedttest(tree,x,y,fixed = T)$P.dbar
  Pvals.orig[nn] <- t.test(x,y)$p.value
  
  ### simulating HGT
  xn <- rnorm(10)
  xn <- sample(xn,replace=T) #random swapping of traits
  names(xn) <- names(x)

  yn <- rnorm(10)
  yn <- sample(yn,replace=T)
  names(yn) <- names(x)
  Pvals.HGT[nn] <- phyl.pairedttest(tree,xn,yn,fixed=T)$P.dbar
  P2[nn] <- t.test(xn,yn)$p.value
}

par(mfrow=c(2,2))
plot(ecdf(Pvals.orig),main='P values from uncorrected t-test')
lines(c(0,1),c(0,1),lwd=2,col='blue')
plot(ecdf(Pvals.phyl),main='P values from PCM-corrected t-test')
lines(c(0,1),c(0,1),lwd=2,col='blue')
plot(ecdf(P2),main='P values from uncorrected t-test w/ HGT')
lines(c(0,1),c(0,1),lwd=2,col='blue')
plot(ecdf(Pvals.HGT),main='P values from PCM-corrected t-test w/ HGT')
lines(c(0,1),c(0,1),lwd=2,col='blue')
```




## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
